<!DOCTYPE html>
<html>
<head>
    <title>WebSocket协议调试</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h2>WebSocket协议调试</h2>
    
    <div id="serverInfo" class="status info"></div>
    
    <div>
        <button onclick="testSocketIO()">测试Socket.IO</button>
        <button onclick="testNativeWS()">测试原生WebSocket</button>
        <button onclick="checkCurrentConfig()">检查当前配置</button>
    </div>
    
    <div id="results"></div>
    
    <script type="module">
        import { getCurrentServer } from './config/api.config.js';
        
        window.checkCurrentConfig = () => {
            const server = getCurrentServer();
            const info = document.getElementById('serverInfo');
            info.innerHTML = `
                <h3>当前服务器配置</h3>
                <p>名称: ${server.name}</p>
                <p>URL: ${server.url}</p>
                <p>协议: ${server.protocol || 'socket.io'}</p>
                <p>LocalStorage: ${localStorage.getItem('api_server') || 'default'}</p>
            `;
        };
        
        window.testSocketIO = async () => {
            const results = document.getElementById('results');
            results.innerHTML += '<div class="status info">测试Socket.IO连接...</div>';
            
            try {
                const { io } = await import('socket.io-client');
                const socket = io('http://localhost:3000', {
                    transports: ['polling', 'websocket']
                });
                
                socket.on('connect', () => {
                    results.innerHTML += `<div class="status success">✓ Socket.IO连接成功! ID: ${socket.id}</div>`;
                    socket.disconnect();
                });
                
                socket.on('connect_error', (error) => {
                    results.innerHTML += `<div class="status error">✗ Socket.IO连接失败: ${error.message}</div>`;
                });
            } catch (error) {
                results.innerHTML += `<div class="status error">✗ 错误: ${error.message}</div>`;
            }
        };
        
        window.testNativeWS = () => {
            const results = document.getElementById('results');
            results.innerHTML += '<div class="status info">测试原生WebSocket连接...</div>';
            
            try {
                const ws = new WebSocket('ws://localhost:3000/ws/terminal');
                
                ws.onopen = () => {
                    results.innerHTML += '<div class="status success">✓ 原生WebSocket连接成功!</div>';
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    results.innerHTML += `<div class="status error">✗ 原生WebSocket连接失败</div>`;
                };
                
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    results.innerHTML += `<div class="status info">收到消息: ${msg.type}</div>`;
                };
            } catch (error) {
                results.innerHTML += `<div class="status error">✗ 错误: ${error.message}</div>`;
            }
        };
        
        // 页面加载时检查配置
        checkCurrentConfig();
    </script>
</body>
</html>