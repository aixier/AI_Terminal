{
  "openapi": "3.0.0",
  "info": {
    "title": "SenseVoice Transcription API",
    "version": "1.0.0",
    "description": "音视频转文字服务API，基于阿里云SenseVoice模型"
  },
  "servers": [
    {
      "url": "http://localhost:3000/api/transcription",
      "description": "本地开发服务器"
    }
  ],
  "paths": {
    "/formats": {
      "get": {
        "summary": "获取支持的文件格式",
        "tags": ["基础信息"],
        "responses": {
          "200": {
            "description": "成功返回支持的格式列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FormatsResponse"
                }
              }
            }
          }
        }
      }
    },
    "/file": {
      "post": {
        "summary": "上传文件进行转录",
        "tags": ["转录任务"],
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "$ref": "#/components/schemas/FileUploadRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "任务提交成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskSubmitResponse"
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      }
    },
    "/url": {
      "post": {
        "summary": "提交URL进行转录",
        "tags": ["转录任务"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UrlTranscriptionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "任务提交成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskSubmitResponse"
                }
              }
            }
          }
        }
      }
    },
    "/batch": {
      "post": {
        "summary": "批量上传文件转录",
        "tags": ["转录任务"],
        "requestBody": {
          "content": {
            "multipart/form-data": {
              "schema": {
                "$ref": "#/components/schemas/BatchUploadRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "批量任务提交成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BatchTaskResponse"
                }
              }
            }
          }
        }
      }
    },
    "/task/{taskId}": {
      "get": {
        "summary": "获取任务状态",
        "tags": ["任务管理"],
        "parameters": [
          {
            "name": "taskId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            },
            "description": "任务ID"
          }
        ],
        "responses": {
          "200": {
            "description": "成功返回任务状态",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskStatusResponse"
                }
              }
            }
          },
          "404": {
            "description": "任务不存在",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          }
        }
      },
      "delete": {
        "summary": "删除任务",
        "tags": ["任务管理"],
        "parameters": [
          {
            "name": "taskId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "任务删除成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SuccessResponse"
                }
              }
            }
          }
        }
      }
    },
    "/task/{taskId}/result": {
      "get": {
        "summary": "获取任务结果",
        "tags": ["任务管理"],
        "parameters": [
          {
            "name": "taskId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "成功返回转录结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TranscriptionResult"
                }
              }
            }
          },
          "202": {
            "description": "任务仍在处理中",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskPendingResponse"
                }
              }
            }
          },
          "400": {
            "description": "任务失败",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                }
              }
            }
          },
          "404": {
            "description": "任务不存在"
          }
        }
      }
    },
    "/task/{taskId}/retry": {
      "post": {
        "summary": "重试失败的任务",
        "tags": ["任务管理"],
        "parameters": [
          {
            "name": "taskId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "重试任务提交成功",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RetryTaskResponse"
                }
              }
            }
          }
        }
      }
    },
    "/tasks": {
      "get": {
        "summary": "获取任务列表",
        "tags": ["任务管理"],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": ["pending", "processing", "succeeded", "failed"]
            },
            "description": "按状态过滤"
          },
          {
            "name": "type",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": ["file", "url", "batch"]
            },
            "description": "按类型过滤"
          },
          {
            "name": "since",
            "in": "query",
            "schema": {
              "type": "string",
              "format": "date-time"
            },
            "description": "起始时间"
          },
          {
            "name": "page",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 1
            },
            "description": "页码"
          },
          {
            "name": "limit",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 20,
              "maximum": 100
            },
            "description": "每页数量"
          }
        ],
        "responses": {
          "200": {
            "description": "成功返回任务列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TaskListResponse"
                }
              }
            }
          }
        }
      }
    },
    "/statistics": {
      "get": {
        "summary": "获取统计信息",
        "tags": ["统计信息"],
        "responses": {
          "200": {
            "description": "成功返回统计信息",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/StatisticsResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "FormatsResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "formats": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "example": ["wav", "mp3", "mp4", "m4a", "aac"]
          },
          "maxFileSize": {
            "type": "string",
            "example": "100MB"
          }
        }
      },
      "FileUploadRequest": {
        "type": "object",
        "required": ["file"],
        "properties": {
          "file": {
            "type": "string",
            "format": "binary",
            "description": "音频或视频文件"
          },
          "format": {
            "type": "string",
            "default": "auto",
            "description": "文件格式"
          },
          "sampleRate": {
            "type": "integer",
            "default": 16000,
            "description": "采样率"
          },
          "languages": {
            "type": "string",
            "description": "语言列表JSON字符串",
            "example": "[\"zh\", \"en\"]"
          },
          "enableWords": {
            "type": "string",
            "enum": ["true", "false"],
            "default": "true",
            "description": "是否返回词级时间戳"
          },
          "enableTimestamp": {
            "type": "string",
            "enum": ["true", "false"],
            "default": "true",
            "description": "是否返回时间戳"
          },
          "removeDisfluency": {
            "type": "string",
            "enum": ["true", "false"],
            "default": "false",
            "description": "是否去除语气词"
          },
          "enablePunctuation": {
            "type": "string",
            "enum": ["true", "false"],
            "default": "true",
            "description": "是否添加标点"
          }
        }
      },
      "UrlTranscriptionRequest": {
        "type": "object",
        "required": ["url"],
        "properties": {
          "url": {
            "type": "string",
            "format": "uri",
            "description": "音频或视频文件URL"
          },
          "format": {
            "type": "string",
            "default": "auto"
          },
          "sampleRate": {
            "type": "integer",
            "default": 16000
          },
          "languages": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "default": ["zh", "en"]
          },
          "enableWords": {
            "type": "boolean",
            "default": true
          },
          "enableTimestamp": {
            "type": "boolean",
            "default": true
          },
          "removeDisfluency": {
            "type": "boolean",
            "default": false
          },
          "enablePunctuation": {
            "type": "boolean",
            "default": true
          }
        }
      },
      "BatchUploadRequest": {
        "type": "object",
        "required": ["files"],
        "properties": {
          "files": {
            "type": "array",
            "items": {
              "type": "string",
              "format": "binary"
            },
            "description": "多个音频或视频文件（最多10个）"
          }
        }
      },
      "TaskSubmitResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "taskId": {
            "type": "string",
            "description": "任务ID"
          },
          "message": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "processing"]
          }
        }
      },
      "BatchTaskResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "batchTaskId": {
            "type": "string"
          },
          "subTasks": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "filename": {
                  "type": "string"
                },
                "taskId": {
                  "type": "string"
                },
                "status": {
                  "type": "string"
                },
                "error": {
                  "type": "string"
                }
              }
            }
          },
          "message": {
            "type": "string"
          }
        }
      },
      "TaskStatusResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "taskId": {
            "type": "string"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "processing", "succeeded", "failed"]
          },
          "progress": {
            "type": "integer",
            "minimum": 0,
            "maximum": 100
          },
          "type": {
            "type": "string",
            "enum": ["file", "url", "batch"]
          },
          "message": {
            "type": "string"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "updatedAt": {
            "type": "string",
            "format": "date-time"
          },
          "startedAt": {
            "type": "string",
            "format": "date-time"
          },
          "completedAt": {
            "type": "string",
            "format": "date-time"
          },
          "executionTime": {
            "type": "integer",
            "description": "执行时间（毫秒）"
          },
          "hasResult": {
            "type": "boolean"
          },
          "error": {
            "type": "string"
          }
        }
      },
      "TranscriptionResult": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "taskId": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "fullText": {
            "type": "string",
            "description": "完整转录文本"
          },
          "sentences": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "text": {
                  "type": "string"
                },
                "startTime": {
                  "type": "number"
                },
                "endTime": {
                  "type": "number"
                },
                "words": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "text": {
                        "type": "string"
                      },
                      "startTime": {
                        "type": "number"
                      },
                      "endTime": {
                        "type": "number"
                      }
                    }
                  }
                }
              }
            }
          },
          "language": {
            "type": "string"
          },
          "duration": {
            "type": "number",
            "description": "音频时长（秒）"
          },
          "wordCount": {
            "type": "integer"
          },
          "sentenceCount": {
            "type": "integer"
          },
          "metadata": {
            "type": "object",
            "properties": {
              "model": {
                "type": "string"
              },
              "processedAt": {
                "type": "string",
                "format": "date-time"
              }
            }
          }
        }
      },
      "TaskPendingResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "taskId": {
            "type": "string"
          },
          "status": {
            "type": "string"
          },
          "message": {
            "type": "string"
          }
        }
      },
      "TaskListResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "tasks": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TaskStatusResponse"
            }
          },
          "total": {
            "type": "integer"
          },
          "page": {
            "type": "integer"
          },
          "limit": {
            "type": "integer"
          },
          "hasMore": {
            "type": "boolean"
          }
        }
      },
      "RetryTaskResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "newTaskId": {
            "type": "string"
          },
          "message": {
            "type": "string"
          }
        }
      },
      "StatisticsResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean"
          },
          "statistics": {
            "type": "object",
            "properties": {
              "total": {
                "type": "integer"
              },
              "byStatus": {
                "type": "object",
                "additionalProperties": {
                  "type": "integer"
                }
              },
              "byType": {
                "type": "object",
                "additionalProperties": {
                  "type": "integer"
                }
              },
              "averageExecutionTime": {
                "type": "integer",
                "description": "平均执行时间（毫秒）"
              },
              "successRate": {
                "type": "number",
                "description": "成功率（百分比）"
              }
            }
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": false
          },
          "error": {
            "type": "string"
          }
        }
      },
      "SuccessResponse": {
        "type": "object",
        "properties": {
          "success": {
            "type": "boolean",
            "example": true
          },
          "message": {
            "type": "string"
          }
        }
      }
    }
  }
}