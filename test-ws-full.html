<!DOCTYPE html>
<html>
<head>
    <title>本地WebSocket测试</title>
    <style>
        body { font-family: monospace; background: #1e1e1e; color: #d4d4d4; padding: 20px; }
        #output { background: black; padding: 10px; height: 400px; overflow-y: auto; white-space: pre-wrap; }
        button { padding: 8px 16px; margin: 5px; }
        .success { color: #0dbc79; }
        .error { color: #cd3131; }
        .info { color: #2472c8; }
    </style>
</head>
<body>
    <h2>本地WebSocket终端测试</h2>
    <div>
        <button onclick="connect()">连接</button>
        <button onclick="disconnect()">断开</button>
        <button onclick="sendCommand()">发送命令</button>
        <button onclick="clearOutput()">清屏</button>
    </div>
    <div id="output"></div>

    <script>
        let ws = null;
        const output = document.getElementById('output');

        function log(msg, type = '') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? `class="${type}"` : '';
            output.innerHTML += `<span ${className}>[${timestamp}] ${msg}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function connect() {
            log('正在连接到 ws://localhost:3000/ws/terminal...', 'info');
            
            ws = new WebSocket('ws://localhost:3000/ws/terminal');
            
            ws.onopen = () => {
                log('✅ WebSocket连接成功！', 'success');
                
                // 发送初始化
                ws.send(JSON.stringify({
                    type: 'init',
                    cols: 80,
                    rows: 24
                }));
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                
                switch(msg.type) {
                    case 'connected':
                        log(`已连接，客户端ID: ${msg.clientId}`, 'success');
                        break;
                    case 'ready':
                        log(`终端就绪，ID: ${msg.terminalId}, PID: ${msg.pid}`, 'success');
                        break;
                    case 'output':
                        output.innerHTML += msg.data;
                        output.scrollTop = output.scrollHeight;
                        break;
                    case 'error':
                        log(`错误: ${msg.error}`, 'error');
                        break;
                    case 'exit':
                        log(`终端退出: ${msg.exitCode}`, 'info');
                        break;
                }
            };
            
            ws.onerror = (error) => {
                log(`WebSocket错误: ${error}`, 'error');
            };
            
            ws.onclose = () => {
                log('连接已关闭', 'info');
                ws = null;
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function sendCommand() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('未连接', 'error');
                return;
            }
            
            const cmd = prompt('输入命令:');
            if (cmd) {
                ws.send(JSON.stringify({
                    type: 'input',
                    data: cmd + '\r'
                }));
            }
        }

        function clearOutput() {
            output.innerHTML = '';
        }
    </script>
</body>
</html>