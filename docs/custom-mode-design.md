# 自定义模式设计方案

## 核心要点（TL;DR）

**接口改动：仅修改两个现有接口，不新增任何接口**
1. `GET /api/assets/categories` - **无需修改**，直接复用获取元数据
2. `POST /api/generate/card/async` - 增加 `mode` 和 `references` 参数

**性能优化：三层缓存架构**
- L1 内存缓存：<1ms 响应
- L2 localStorage：<10ms 响应  
- L3 服务器请求：200-500ms（仅首次或缓存失效时）

**用户体验：零延迟@符号响应**
- 输入空格+@立即显示选择器（使用本地缓存）
- 后台静默更新，不阻塞用户操作
- 支持自由格式引用，无需特殊语法

---

## 一、需求概述

### 1.1 背景
当前系统支持快速和精细两种预设模板模式，用户需要更灵活的自定义生成能力，能够引用自己的素材资源来辅助AI生成内容。

### 1.2 核心需求
1. 在输入面板上方添加"自定义模式"切换按钮
2. 自定义模式下，支持通过 `@` 符号引用用户素材
3. 素材选择支持分类浏览和文件选择
4. 后端能够识别并处理带有素材引用的生成请求
5. 支持自然语言格式的引用，降低学习成本

### 1.3 用户价值
- **个性化创作**：使用自己的素材库生成定制化内容
- **上下文增强**：通过引用具体文件提供更精准的生成上下文
- **效率提升**：快速引用已有资源，无需重复描述
- **零学习成本**：像写普通文本一样引用素材

---

## 二、UX设计方案

### 2.1 界面布局

```
┌─────────────────────────────────────────────────────┐
│                    输入面板区域                       │
├─────────────────────────────────────────────────────┤
│  [快速] [精细]             [🎨 自定义模式] [⚙️高级]   │  ← 模式选择栏
├─────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────┐    │
│  │  输入你的创作需求...                          │    │
│  │  空格@[光标位置触发素材选择器]               │    │
│  │                                              │    │
│  └─────────────────────────────────────────────┘    │
│                                    [发送]            │
└─────────────────────────────────────────────────────┘
```

### 2.2 @符号触发规则

#### 2.2.1 触发条件
- **必须有前置空格**：避免误触发（如邮箱地址）
- **开头位置例外**：在输入框开头直接输入@也可触发
- **触发模式**：`空格+@` 或 `^@`（开头）

#### 2.2.2 支持的引用格式

**自由格式（推荐）**
```
阅读播客 @小红书图文卡片需求文档.md，按文档要求使用 @新闻感封面.md 和 @内容页模板规范.md 的规范，
为第二期生成html文档。需要使用的照片在 @照片 中。
需要使用的其他素材在 @CDN 中。
```

**标准格式（兼容）**
```
@[category:projects.designs]
@[file:需求文档.pdf]
```

### 2.3 素材选择器设计

#### 2.3.1 选择器界面
```
┌────────────────────────┐
│  选择引用类型          │
├────────────────────────┤
│  📁 按分类浏览         │
│  📄 按文件浏览         │
│  ❌ 取消              │
└────────────────────────┘

↓ 选择后展示对应列表

┌────────────────────────┐
│  选择分类/文件         │
├────────────────────────┤
│  🔍 搜索框             │
├────────────────────────┤
│  📁 项目文档           │
│  📁 设计稿             │
│  📄 需求文档.pdf       │
│  ...                   │
└────────────────────────┘
```

#### 2.3.2 引用插入规则
- **自动添加前置空格**：如果@前没有空格，自动添加
- **自动添加后置空格**：避免与后续内容粘连
- **光标定位**：插入后光标定位到引用后的空格后

---

## 三、技术架构设计

### 3.1 三层缓存架构

#### 缓存层级设计
```
用户输入@ 
    ↓
L1 内存缓存检查 (<1ms)
    ↓ [未命中]
L2 localStorage检查 (<10ms)  
    ↓ [未命中]
L3 服务器请求 (200-500ms)
    ↓
更新L1、L2缓存
    ↓
显示选择器
```

#### 缓存策略
- **L1 内存缓存**：组件内ref变量，生命周期内有效
- **L2 localStorage**：持久化存储，24小时过期
- **L3 服务器**：实时数据源
- **后台更新**：使用缓存后静默检查更新

### 3.2 前端架构

#### 3.2.1 组件结构
- `CustomModeToggle.vue` - 自定义模式切换按钮
- `AssetReferencePicker.vue` - 素材选择器
- `useAssetCache.js` - 缓存管理模块
- `referenceParser.js` - 引用解析工具

#### 3.2.2 引用解析流程
1. 检测空格+@触发条件
2. 显示素材选择器（优先使用缓存）
3. 用户选择素材
4. 插入简化格式引用（@文件名）
5. 发送时解析所有引用

### 3.3 后端架构

#### 3.3.1 接口设计
**复用现有接口**
- `GET /api/assets/categories` - 获取素材元数据（无需修改）

**修改现有接口**
- `POST /api/generate/card/async` - 增加参数：
  - `mode`: 'custom' | 'normal'
  - `references`: 引用数组

#### 3.3.2 引用处理流程
1. 接收包含引用的请求
2. 解析引用类型（文件/分类）
3. 转换为实际文件系统路径
4. 构建增强提示词
5. 传递给AI模型处理

---

## 四、引用格式与解析

### 4.1 前端引用格式

#### 自由格式示例
```
输入：请参考 @需求文档.pdf 和 @设计规范.md 进行开发
解析：
- 文件：需求文档.pdf
- 文件：设计规范.md

输入：使用 @项目文档 中的所有文件
解析：
- 分类：项目文档
```

### 4.2 后端路径转换

#### 转换示例
```
用户引用：@小红书图文卡片需求文档.md
实际路径：/data/users/default/storage/小红书图文卡片需求文档.md

用户引用：@照片（分类）
实际路径：
- /data/users/default/storage/主播李静.jpg
- /data/users/default/storage/主播养鸡.jpg
- ...（分类下所有文件）
```

### 4.3 提示词构建

#### 最终提示词格式
```markdown
## 用户请求
[原始请求内容]

## 参考文件和素材

### 文件：小红书图文卡片需求文档.md
- 路径：/data/users/default/storage/小红书图文卡片需求文档.md
- 类型：markdown
- 操作：请仔细阅读此文档

### 分类：照片
包含以下文件：
- 主播李静.jpg (/data/users/default/storage/主播李静.jpg)
- 主播养鸡.jpg (/data/users/default/storage/主播养鸡.jpg)
...

## 生成要求
[基于引用内容的具体要求]
```

---

## 五、实施策略

### 5.1 前端改动要点
- **新增组件**：模式切换按钮、选择器浮层
- **缓存机制**：三层缓存实现零延迟
- **引用解析**：支持自由格式和标准格式
- **交互优化**：自动空格处理、光标管理

### 5.2 后端改动要点
- **最小化改动**：仅修改一个接口，增加两个参数
- **路径转换**：引用到文件系统路径的映射
- **提示词增强**：构建包含文件路径的完整提示
- **容错处理**：文件不存在时的降级策略

### 5.3 性能优化策略
- **预加载**：应用启动时预加载元数据到缓存
- **懒加载**：首次使用时才加载选择器组件
- **增量更新**：后台静默更新，不阻塞用户
- **数据压缩**：localStorage使用LZString压缩

---

## 六、测试要点

### 6.1 功能测试
- [x] 空格+@触发选择器
- [x] 自由格式引用解析
- [x] 引用自动添加空格
- [x] 缓存三层级工作
- [x] 后端路径转换正确

### 6.2 性能测试
- [x] 首次加载 < 500ms
- [x] 缓存响应 < 10ms
- [x] 文件读取 < 2s

### 6.3 兼容性测试
- [x] 现有功能不受影响
- [x] 标准格式仍然支持
- [x] 错误降级处理

---

## 七、注意事项

### 前端注意事项
1. **空格检测**：必须检测@前的空格，避免邮箱等误触发
2. **自动补空格**：插入引用后自动添加空格
3. **光标管理**：插入后光标定位到引用后的空格后
4. **缓存过期**：合理设置缓存过期时间

### 后端注意事项
1. **灵活匹配**：支持通过文件名或分类名查找
2. **路径验证**：检查文件是否存在
3. **错误处理**：找不到的文件给出警告但不中断
4. **性能考虑**：大量文件引用时的处理优化

---

## 八、未来扩展

### 8.1 智能推荐
- 基于历史使用推荐素材
- 根据上下文智能匹配相关文件
- 学习用户偏好优化推荐

### 8.2 协作功能
- 共享素材库支持
- 团队模板管理
- 引用权限控制

### 8.3 高级引用
- 文件片段引用（如：@文档.md#第二章）
- 条件引用（如：@最新版本的设计稿）
- 动态引用（如：@今天的会议记录）

---

## 九、实施成果

### 已完成功能
- ✅ 零延迟@符号响应（本地缓存）
- ✅ 自由格式引用支持
- ✅ 智能空格处理
- ✅ 三层缓存架构
- ✅ 最小化接口改动（仅2个）

### 用户体验提升
- 🚀 响应速度提升100倍（缓存命中时）
- 📝 支持自然语言引用，无需记忆语法
- 🎯 精准的文件路径转换
- 💾 智能缓存管理，后台静默更新

---

## 相关文档
- [素材管理系统设计](/docs/assets-metadata-final-solution.md)
- [实施任务清单](/docs/custom-mode-implementation-tasks.md)
- [完成报告](/docs/custom-mode-completion-report.md)